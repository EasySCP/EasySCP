/**
 * Roundcube Treelist Widget
 *
 * This file is part of the Roundcube Webmail client
 *
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this file.
 *
 * Copyright (c) 2013-2014, The Roundcube Dev Team
 *
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in this file.
 *
 * @author Thomas Bruederli <roundcube@gmail.com>
 * @requires jquery.js, common.js
 */
function rcube_treelist_widget(ga,g){var K,L,M,N;function B(a,b,c){var d;if(d=h[a]){d.collapsed="undefined"==typeof c||c;var f=l(d.id,!0);f.attr("aria-expanded",d.collapsed?"false":"true");f.children("ul").first()[d.collapsed?"hide":"show"]();f.children("div.treetoggle").removeClass("collapsed expanded").addClass(d.collapsed?"collapsed":"expanded");t.triggerEvent("toggle",d);if(b&&d.children)for(f=0;f<d.children.length;f++)B(d.children[f].id,b,c);t.triggerEvent(d.collapsed?"collapse":"expand",d);
b=d.collapsed;g.save_state&&window.rcmail&&(c="treelist-"+U,u||(u=rcmail.local_storage_get_item(c,{})),u[a]!=b&&(u[a]=b,rcmail.local_storage_set_item(c,u)))}}function V(a,b){B(a,b,!1)}function G(a){if(!1!==t.triggerEvent("beforeselect",h[a])&&(m&&(l(m,!0).removeClass("selected").removeAttr("aria-selected"),k&&l(m).removeClass("selected").removeAttr("aria-selected"),m=null),a)){var b=l(a,!0);if(b.length){b.addClass("selected").attr("aria-selected","true");m=a;k&&l(a).addClass("selected").attr("aria-selected",
"true");var c=e.parent(),d=c.scrollTop(),f=b.offset().top-c.offset().top;(0>f||f+b.height()>c.height())&&c.scrollTop(f+d)}t.triggerEvent("select",h[a])}}function W(a,b){return l(a,b).get(0)}function X(a,b){var c,d,f=a.get(0).id,g=a.children().first().text().toUpperCase();a.parent().children("li"+b).each(function(a,b){0==a&&(c=b);if(b.id!=f)if(b.id!=f&&g>=$(b).children().first().text().toUpperCase())d=b;else return!1});d?a.insertAfter(d):c&&c.id!=f&&a.insertBefore(c);p=H(e,0)}function Y(a,b){a=String(a).toLowerCase();
if(!a.length)return C();if(a==D&&!b)return 0;var c=[],d=function(b){$.each(b,function(b,f){var g;if(!f.virtual&&!f.deleted&&0<=String(f.text).toLowerCase().indexOf(a)&&0>c.indexOf(f.id)){g=l(f.id);if(g.data("filtered"))return;$("<li>").attr("id",g.attr("id")+"--xsR").attr("class",g.attr("class")).addClass("searchresult__").append(g.children(":not(div.treetoggle,ul)").clone(!0,!0)).appendTo(e);c.push(f.id)}f.children&&f.children.length&&d(f.children)})};k&&($(e).children("li.searchresult__").remove(),
k=!1);$(e).children("li").hide().removeClass("selected");d(p);k=!0;D=a;t.triggerEvent("search",{query:a,last:D,count:c.length,ids:c,execute:b||!1});return c.count}function C(){I&&I.val("");$(e).children("li.searchresult__").remove();$(e).children("li").filter(function(){return!$(this).data("filtered")}).show();k=!1;t.triggerEvent("search",{query:!1,last:D});D="";m&&G(m)}function z(a,b,c){if(!a.deleted){var d=$("<li>").attr("id",g.id_prefix+(g.id_encode?g.id_encode(a.id):a.id)).attr("role","treeitem").addClass((a.classes||
[]).join(" ")).data("id",a.id);c?(c.replaceWith(d),b&&d.appendTo(b)):d.appendTo(b);"string"==typeof a.html?d.html(a.html):"object"==typeof a.html&&d.append(a.html);a.text||(a.text=d.children().first().text());a.virtual&&d.addClass("virtual");a.id==m&&d.addClass("selected");if(a.children&&a.children.length)for(d.attr("aria-expanded",a.collapsed?"false":"true"),$('<div class="treetoggle '+(a.collapsed?"collapsed":"expanded")+'">&nbsp;</div>').appendTo(d),b=$("<ul>").appendTo(d).attr("class",a.childlistclass).attr("role",
"group"),a.collapsed&&b.hide(),c=0;c<a.children.length;c++)a.children[c].level=a.level+1,z(a.children[c],b);return d}}function H(a,b){var c=[];a.children("li").each(function(a,f){var d,e=$(f),g=e.children("ul"),n={id:A(e),classes:String(e.attr("class")).split(" "),virtual:e.hasClass("virtual"),level:b,html:e.children().first().get(0).outerHTML,text:e.children().first().text(),children:H(g,b+1)};g.length&&(n.childlistclass=g.attr("class"));n.children.length&&(void 0===n.collapsed&&(n.collapsed="none"==
g.css("display")),d=Z(n.id,n.collapsed),void 0!==d&&(n.collapsed=d,g[d?"hide":"show"]()),e.children("div.treetoggle").length||$('<div class="treetoggle '+(n.collapsed?"collapsed":"expanded")+'">&nbsp;</div>').appendTo(e),e.attr("aria-expanded",n.collapsed?"false":"true"));e.hasClass("selected")&&(e.attr("aria-selected","true"),m=n.id);e.data("id",n.id);e.attr("role","treeitem").attr("aria-level",n.level+1);n.virtual&&e.children("a:first").attr("tabindex","0");c.push(n);h[n.id]=n});a.attr("role",0==
b?"tree":"group");return c}function aa(a){a.id&&(h[a.id]=a);for(var b=0;a.children&&b<a.children.length;b++)aa(a.children[b])}function A(a){a=String(a.attr("id")).replace(new RegExp("^"+g.id_prefix||"%"),"").replace(/--xsR$/,"");return g.id_decode?g.id_decode(a):a}function l(a,b){var c=g.id_encode?g.id_encode(a):a;return $("#"+g.id_prefix+c+(k&&!b?"--xsR":""),e)}function Z(a){if(g.save_state&&window.rcmail)return u||(u=rcmail.local_storage_get_item("treelist-"+U,{})),u[a]}function ba(a,b,c){var d=
a[0>b?"prev":"next"]();0<b&&!c&&a.children("ul[role=group]:visible").length?a.children("ul").children("li:first").find("a:first").focus():0>b&&!c&&d.children("ul[role=group]:visible").length?d.children("ul").children("li:last").find("a:first").focus():d.length&&d.find("a:first").focus().length||(a=a.parent().closest("li[role=treeitem]"),a.length&&(0>b?a.find("a:first").focus():ba(a,b,!0)))}function O(a){if(a||!x){x=!0;var b,c=e.offset();ca=bw.ie?0:window.pageYOffset;y=e.parent().scrollTop();c.top+=
y;K=c.left;L=c.top;M=c.left+e.width();N=c.top+e.height();J=[];for(var d in h)if(a=l(d),a=a.children().first().get(0),b=a.offsetHeight)c=$(a).offset(),c.top+=y,J[d]={x1:c.left,y1:c.top,x2:c.left+a.offsetWidth,y2:c.top+b,on:d==w};e.height()>e.parent().height()&&e.parent().mousemove(function(a){var b=0;a=rcube_event.get_mouse_pos(a);a.y-=e.parent().offset().top;25>a.y&&0<y?b=-1:a.y>e.parent().height()-25&&(b=1);x&&0!=b?q||(q=window.setTimeout(function(){da(b)},g.scroll_delay)):q&&(window.clearTimeout(q),
q=null)}).mouseleave(function(){q&&(window.clearTimeout(q),q=null)})}}function ea(){x&&(x=!1,q=null,r&&(clearTimeout(r),w=r=null),$("li.droptarget",e).removeClass("droptarget"))}function da(a){if(x){var b=y;e.parent().get(0).scrollTop+=g.scroll_step*a;y=e.parent().scrollTop();q=null;y!=b&&(q=window.setTimeout(function(){da(a)},g.scroll_speed))}}function fa(a,b){var c=bw.ie?-document.documentElement.scrollTop:ca,d=e.parent().scrollTop(),f=null;a.top=a.y+d-c;if(a.x<K||a.x>=M||a.top<L||a.top>=N)return b&&
$("li.droptarget",e).removeClass("droptarget"),f;for(var v in J)c=J[v],a.x>=c.x1&&a.x<c.x2&&a.top>=c.y1&&a.top<c.y2?(f=h[v],f.children&&f.children.length&&f.collapsed&&g.autoexpand&&w!=v?(r&&clearTimeout(r),w=v,r=setTimeout(function(){V(w);O(!0);w=null;E&&$.ui.ddmanager.prepareOffsets($.ui.ddmanager.current,null)},g.autoexpand)):r&&w!=v&&(clearTimeout(r),r=w=null),g.check_droptarget(f)?(b&&(l(v).addClass("droptarget"),c.on=!0),f=v):f=null):c.on&&(l(v).removeClass("droptarget"),c.on=!1);return f}function P(a){a||
(a={});if("string"==$.type(a))return"destroy"==a&&(E=null),$("li:not(.virtual)",e).droppable(a),this;Q=a;var b=$.extend({greedy:!0,tolerance:"pointer",hoverClass:"droptarget",addClasses:!1},a);b.activate=function(b,d){O();E=d;a.activate&&a.activate(b,d)};b.deactivate=function(b,d){ea();E=null;a.deactivate&&a.deactivate(b,d)};b.over=function(b,d){fa(rcube_event.get_mouse_pos(b),!1);a.over&&a.over(b,d)};$("li:not(.virtual)",e).droppable(b);return this}function R(a){a||(a={});if("string"==$.type(a))return"destroy"==
a&&(S=null),$("li:not(.virtual)",e).draggable(a),this;T=a;a=$.extend({appendTo:"body",revert:"invalid",iframeFix:!0,addClasses:!1,cursorAt:{left:-20,top:5},create:function(a,c){S=c},helper:function(a){return $("<div>").attr("id","rcmdraglayer").text($.trim($(a.target).first().text()))}},a);$("li:not(.virtual)",e).draggable(a);return this}g=$.extend({id_prefix:"",autoexpand:1E3,selectable:!1,scroll_delay:500,scroll_step:5,scroll_speed:20,save_state:!1,keyboard:!0,tabexit:!0,parent_focus:!1,check_droptarget:function(a){return!a.virtual}},
g||{});var e=$(ga),p=g.data||[],h={},m=null,x=!1,k=!1,D="",F=!1;N=M=L=K=void 0;var J=[],r,w,ca=0,y=0,q,I,u,E,S,T,Q,U=e.attr("id")||g.id_prefix||"0",t=this;this.container=e;this.expand=V;this.collapse=B;this.select=G;this.render=function(){if(!1!==t.triggerEvent("renderBefore",p)){e.html("");for(var a=0;a<p.length;a++)p[a].level=0,z(p[a],e);t.triggerEvent("renderAfter",e)}};this.reset=function(a){G("");p=[];h={};x=!1;a?(T&&(S&&R("destroy"),R(T)),Q&&(E&&P("destroy"),P(Q)),p=H(e,0)):e.html("");C()};
this.drag_start=O;this.drag_end=ea;this.intersects=fa;this.droppable=P;this.draggable=R;this.update=function(a,b,c){var d,f,g,m,k=h[a];if(k){d=l(a);f=d.parent();if(b.id||b.html||b.children||b.classes||b.parent)b.parent&&(g=h[b.parent])?(f.closest("li").length&&(m=h[A(f.closest("li"))])&&(m.children=$.grep(m.children,function(a,b){return a.id!=k.id})),f=l(b.parent).children("ul").first(),g.children||(g.children=[]),g.children.push(k)):void 0!==b.parent&&(f=e),$.extend(k,b),d=z(k,f,d);k.id!=a&&(delete h[a],
h[k.id]=k);c&&X(d,"string"==typeof c?'[class~="'+c+'"]':"")}};this.insert=function(a,b,c){var d;d=b?h[b]:null;search_=k;h[a.id]||(state=Z(a.id,a.collapsed),void 0!==state&&(a.collapsed=state),d?(a.level=d.level+1,d.children||(d.children=[]),k=!1,d.children.push(a),b=l(b),1==d.children.length?(z(d,null,b),d=l(a.id)):d=z(a,b.children("ul").first()),search_&&(k=search_,d.is(":visible")||$("<li>").attr("id",d.attr("id")+"--xsR").attr("class",d.attr("class")).addClass("searchresult__").append(d.children().first().clone(!0,
!0)).appendTo(e))):(a.level=0,p.push(a),d=z(a,e)),h[a.id]=a,"object"==typeof a.html&&(h[a.id].html=l(a.id,!0).children()),c&&X(d,"string"==typeof c?'[class~="'+c+'"]':""))};this.remove=function(a){var b,c;return(b=h[a])?(c=l(a,!0),c.remove(),b.deleted=!0,delete h[a],k&&l(a,!1).remove(),!0):!1};this.get_item=W;this.get_node=function(a){return h[a]};this.get_selection=function(){return m};this.is_search=function(){return k};this.reset_search=C;e.length&&(g.data?aa({children:p}):p=H(e,0),e.on("click",
"div.treetoggle",function(a){var b=A($(this).parent()),c;(c=h[b])&&B(b,void 0,!c.collapsed);a.stopPropagation()}),e.on("click","li",function(a){if($(a.target).is("input"))return!0;var b=g.selectable?h[A($(this))]:null;b&&!b.virtual&&(G(b.id),a.stopPropagation())}),e.on("mousedown","a",function(a){var b=$(a.target),c=h[A(b.closest("li"))];if(c&&c.virtual&&!b.attr("href"))return a.preventDefault(),a.stopPropagation(),!1}),g.searchbox&&(I=$(g.searchbox).on("keyup",function(a){var b=rcube_event.get_keycode(a);
rcube_event.get_modifier(a);switch(b){case 9:break;case 13:return Y(this.value,!0),rcube_event.cancel(a);case 27:C();break;case 38:case 37:case 39:case 40:break;default:Y(this.value,!1)}}).attr("autocomplete","off"),I.parent().find("a.reset").click(function(a){C();return!1})),e.on("focusin",function(a){F=!0}).on("focusout",function(a){F=!1}),e.attr("role","tree"),$(document.body).bind("keydown",function(a){var b=a.target||{},c=rcube_event.get_keycode(a);if(!F||"INPUT"==b.nodeName&&38!=c&&40!=c||"TEXTAREA"==
b.nodeName||"SELECT"==b.nodeName)return!0;switch(c){case 38:case 40:case 63232:case 63233:return b=g.keyboard?e.find(":focus").closest("li"):[],b.length&&ba(b,mod=38==c||63232==c?-1:1),rcube_event.cancel(a);case 37:case 39:var d,b=e.find(":focus").closest("li");if(b.length&&(b=A(b),(d=h[b])&&d.children.length&&d.collapsed!=(37==c))){a=rcube_event.get_modifier(a)==SHIFT_KEY;var f;(f=h[b])&&B(b,a,!f.collapsed)}return!1;case 9:g.keyboard&&g.tabexit&&(f=rcube_event.get_modifier(a)==SHIFT_KEY?"first":
"last",f=e.find("li[role=treeitem]:has(a)")[f]().find("a:"+f),f.length&&(a=e.parent().get(0)||{scrollTop:0},c=a.scrollTop||a.scrollY,f.focus(),a.scrollTop=c))}return!0}),g.parent_focus&&e.parent(":not(body)").click(function(a){!F&&m?$(W(m)).find(":focusable").first().focus():F||e.children("li:has(:focusable)").first().find(":focusable").first().focus()}))}rcube_treelist_widget.prototype.addEventListener=rcube_event_engine.prototype.addEventListener;
rcube_treelist_widget.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener;rcube_treelist_widget.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;
